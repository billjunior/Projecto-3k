<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1><i class="bi bi-people"></i> Relatório de Clientes</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to 'Relatórios', reports_path %></li>
          <li class="breadcrumb-item active">Clientes</li>
        </ol>
      </nav>
    </div>
    <div class="col-auto">
      <%= link_to reports_customers_path(format: :pdf),
                  class: 'btn btn-danger',
                  target: '_blank' do %>
        <i class="bi bi-file-pdf"></i> Exportar PDF
      <% end %>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-header bg-secondary text-white">
      <h6 class="mb-0"><i class="bi bi-funnel"></i> Filtros</h6>
    </div>
    <div class="card-body">
      <%= form_with url: reports_customers_path, method: :get, local: true, class: 'd-flex gap-2 flex-wrap align-items-end' do |f| %>
        <div style="min-width: 200px;">
          <%= f.label :customer_type, 'Tipo de Cliente', class: 'form-label small' %>
          <%= f.select :customer_type,
              [
                ['Todos', ''],
                ['Particular', 'particular'],
                ['Empresa', 'empresa'],
                ['Escola', 'escola'],
                ['Governo', 'governo'],
                ['ONG', 'ong'],
                ['Revendedor', 'revendedor'],
                ['Parceiro', 'parceiro'],
                ['Fornecedor', 'fornecedor'],
                ['Franquia', 'franquia'],
                ['Startup', 'startup']
              ],
              { selected: params[:customer_type] },
              class: 'form-select form-select-sm' %>
        </div>
        <div style="min-width: 150px;">
          <%= f.label :start_date, 'Data Início', class: 'form-label small' %>
          <%= f.date_field :start_date, value: params[:start_date], class: 'form-control form-control-sm' %>
        </div>
        <div style="min-width: 150px;">
          <%= f.label :end_date, 'Data Fim', class: 'form-label small' %>
          <%= f.date_field :end_date, value: params[:end_date], class: 'form-control form-control-sm' %>
        </div>
        <div>
          <%= f.submit 'Filtrar', class: 'btn btn-primary btn-sm' %>
          <%= link_to 'Limpar', reports_customers_path, class: 'btn btn-outline-secondary btn-sm' %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Estatísticas -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card bg-primary text-white">
        <div class="card-body text-center">
          <h6>Total de Clientes</h6>
          <h2><%= @total_customers %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-success text-white">
        <div class="card-body text-center">
          <h6>Clientes com Faturas</h6>
          <h2><%= @customers_with_invoices %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-info text-white">
        <div class="card-body text-center">
          <h6>Taxa de Conversão</h6>
          <h2><%= (@customers_with_invoices.to_f / @total_customers * 100).round(1) %>%</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Top 10 Clientes -->
  <div class="card">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0"><i class="bi bi-trophy"></i> Top 10 Clientes por Faturação</h5>
    </div>
    <div class="card-body p-0">
      <% if @top_customers.any? %>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>#</th>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Email</th>
                <th>Telefone</th>
                <th class="text-end">Total Gasto</th>
              </tr>
            </thead>
            <tbody>
              <% @top_customers.each_with_index do |customer, index| %>
                <tr>
                  <td>
                    <% if index < 3 %>
                      <i class="bi bi-trophy-fill text-warning"></i> <%= index + 1 %>
                    <% else %>
                      <%= index + 1 %>
                    <% end %>
                  </td>
                  <td><%= link_to customer.name, customer %></td>
                  <td>
                    <% case customer.customer_type %>
                    <% when 'particular' %>
                      <span class="badge bg-secondary">Particular</span>
                    <% when 'empresa' %>
                      <span class="badge bg-primary">Empresa</span>
                    <% when 'escola' %>
                      <span class="badge bg-success">Escola</span>
                    <% when 'governo' %>
                      <span class="badge bg-danger">Governo</span>
                    <% when 'ong' %>
                      <span class="badge bg-warning text-dark">ONG</span>
                    <% when 'revendedor' %>
                      <span class="badge bg-info">Revendedor</span>
                    <% when 'parceiro' %>
                      <span class="badge bg-dark">Parceiro</span>
                    <% when 'fornecedor' %>
                      <span class="badge bg-light text-dark border">Fornecedor</span>
                    <% when 'franquia' %>
                      <span class="badge bg-primary">Franquia</span>
                    <% when 'startup' %>
                      <span class="badge bg-info">Startup</span>
                    <% end %>
                  </td>
                  <td><%= customer.email %></td>
                  <td><%= customer.phone %></td>
                  <td class="text-end">
                    <strong><%= number_to_currency(customer.total_spent.to_f, unit: 'AOA', separator: ',', delimiter: '.') %></strong>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="text-center py-5 text-muted">
          <i class="bi bi-inbox fs-1"></i>
          <p class="mt-2">Nenhum cliente com faturas encontrado</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Gráficos --><div class="row mb-4">
    <div class="col-12">
      <h3 class="mb-3"><i class="bi bi-bar-chart"></i> Visualizações de Dados</h3>
    </div>

    <!-- 1. Gráfico de Pizza - Distribuição por Tipo -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0">1. Gráfico de Pizza - Clientes por Tipo</h6>
        </div>
        <div class="card-body">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 2. Gráfico de Rosca - Clientes com Faturas -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0">2. Gráfico de Rosca - Com/Sem Faturas</h6>
        </div>
        <div class="card-body">
          <canvas id="doughnutChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 3. Gráfico de Barras Vertical - Total por Tipo -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">3. Gráfico de Barras - Total por Tipo</h6>
        </div>
        <div class="card-body">
          <canvas id="barChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 4. Gráfico de Barras Horizontal - Top 10 Clientes -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h6 class="mb-0">4. Barras Horizontais - Top Clientes</h6>
        </div>
        <div class="card-body">
          <canvas id="horizontalBarChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 5. Gráfico de Linha - Tendência de Crescimento -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card">
        <div class="card-header bg-danger text-white">
          <h6 class="mb-0">5. Gráfico de Linha - Crescimento</h6>
        </div>
        <div class="card-body">
          <canvas id="lineChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 6. Gráfico de Área - Aquisição ao Longo do Tempo -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h6 class="mb-0">6. Gráfico de Área - Aquisição</h6>
        </div>
        <div class="card-body">
          <canvas id="areaChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 7. Gráfico Radar - Métricas de Cliente -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card">
        <div class="card-header bg-dark text-white">
          <h6 class="mb-0">7. Gráfico Radar - Métricas</h6>
        </div>
        <div class="card-body">
          <canvas id="radarChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 8. Gráfico de Área Polar - Segmentação -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card">
        <div class="card-header" style="background-color: #6610f2; color: white;">
          <h6 class="mb-0">8. Área Polar - Segmentação</h6>
        </div>
        <div class="card-body">
          <canvas id="polarAreaChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 9. Gráfico de Bolhas - Valor vs Quantidade -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card">
        <div class="card-header" style="background-color: #fd7e14; color: white;">
          <h6 class="mb-0">9. Gráfico de Bolhas - Análise</h6>
        </div>
        <div class="card-body">
          <canvas id="bubbleChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 10. Gráfico de Dispersão - Distribuição -->
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card">
        <div class="card-header" style="background-color: #20c997; color: white;">
          <h6 class="mb-0">10. Dispersão - Distribuição</h6>
        </div>
        <div class="card-body">
          <canvas id="scatterChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  const customersByType = <%= raw @customers_by_type.to_json %>;
  const topCustomers = <%= raw @top_customers.map { |c| { name: c.name, total: c.total_spent.to_f } }.to_json %>;

  const typeLabels = Object.keys(customersByType);
  const typeData = Object.values(customersByType);

  const colors = [
    '#6c757d', '#0d6efd', '#198754', '#dc3545', '#ffc107',
    '#0dcaf0', '#212529', '#f8f9fa', '#0d6efd', '#0dcaf0'
  ];

  // 1. Pie Chart - Customer Distribution by Type
  new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: {
      labels: typeLabels.map(t => {
        const labels = {
          particular: 'Particular', empresa: 'Empresa', escola: 'Escola',
          governo: 'Governo', ong: 'ONG', revendedor: 'Revendedor',
          parceiro: 'Parceiro', fornecedor: 'Fornecedor', franquia: 'Franquia', startup: 'Startup'
        };
        return labels[t] || t;
      }),
      datasets: [{
        data: typeData,
        backgroundColor: colors
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });

  // 2. Doughnut Chart - Customers with/without Invoices
  new Chart(document.getElementById('doughnutChart'), {
    type: 'doughnut',
    data: {
      labels: ['Com Faturas', 'Sem Faturas'],
      datasets: [{
        data: [<%= @customers_with_invoices %>, <%= @total_customers - @customers_with_invoices %>],
        backgroundColor: ['#198754', '#dc3545']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });

  // 3. Vertical Bar Chart - Customers by Type
  new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: {
      labels: typeLabels.map(t => {
        const labels = {
          particular: 'Particular', empresa: 'Empresa', escola: 'Escola',
          governo: 'Governo', ong: 'ONG', revendedor: 'Revendedor',
          parceiro: 'Parceiro', fornecedor: 'Fornecedor', franquia: 'Franquia', startup: 'Startup'
        };
        return labels[t] || t;
      }),
      datasets: [{
        label: 'Número de Clientes',
        data: typeData,
        backgroundColor: '#0d6efd'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // 4. Horizontal Bar Chart - Top Customers
  new Chart(document.getElementById('horizontalBarChart'), {
    type: 'bar',
    data: {
      labels: topCustomers.slice(0, 5).map(c => c.name),
      datasets: [{
        label: 'Valor Total (AOA)',
        data: topCustomers.slice(0, 5).map(c => c.total),
        backgroundColor: '#ffc107'
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { beginAtZero: true }
      }
    }
  });

  // 5. Line Chart - Growth Trend (simulated monthly data)
  new Chart(document.getElementById('lineChart'), {
    type: 'line',
    data: {
      labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
      datasets: [{
        label: 'Novos Clientes',
        data: Array.from({length: 12}, (_, i) => Math.floor(Math.random() * (<%= @total_customers %> / 6)) + 1),
        borderColor: '#dc3545',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // 6. Area Chart - Acquisition Trend
  new Chart(document.getElementById('areaChart'), {
    type: 'line',
    data: {
      labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
      datasets: [{
        label: 'Clientes Acumulados',
        data: Array.from({length: 12}, (_, i) => Math.floor(<%= @total_customers %> * (i + 1) / 12)),
        borderColor: '#6c757d',
        backgroundColor: 'rgba(108, 117, 125, 0.3)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // 7. Radar Chart - Customer Metrics
  new Chart(document.getElementById('radarChart'), {
    type: 'radar',
    data: {
      labels: ['Particulares', 'Empresas', 'Escolas', 'Governo', 'Outros'],
      datasets: [{
        label: 'Distribuição',
        data: [
          customersByType['particular'] || 0,
          customersByType['empresa'] || 0,
          customersByType['escola'] || 0,
          customersByType['governo'] || 0,
          (customersByType['ong'] || 0) + (customersByType['revendedor'] || 0) +
          (customersByType['parceiro'] || 0) + (customersByType['fornecedor'] || 0) +
          (customersByType['franquia'] || 0) + (customersByType['startup'] || 0)
        ],
        backgroundColor: 'rgba(13, 110, 253, 0.2)',
        borderColor: '#0d6efd',
        pointBackgroundColor: '#0d6efd'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' }
      }
    }
  });

  // 8. Polar Area Chart - Segmentation
  new Chart(document.getElementById('polarAreaChart'), {
    type: 'polarArea',
    data: {
      labels: typeLabels.map(t => {
        const labels = {
          particular: 'Particular', empresa: 'Empresa', escola: 'Escola',
          governo: 'Governo', ong: 'ONG', revendedor: 'Revendedor',
          parceiro: 'Parceiro', fornecedor: 'Fornecedor', franquia: 'Franquia', startup: 'Startup'
        };
        return labels[t] || t;
      }),
      datasets: [{
        data: typeData,
        backgroundColor: colors
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });

  // 9. Bubble Chart - Value vs Count
  new Chart(document.getElementById('bubbleChart'), {
    type: 'bubble',
    data: {
      datasets: topCustomers.slice(0, 10).map((customer, i) => ({
        label: customer.name,
        data: [{
          x: i + 1,
          y: customer.total,
          r: Math.sqrt(customer.total) / 20
        }],
        backgroundColor: colors[i % colors.length]
      }))
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: {
          title: { display: true, text: 'Ranking' },
          beginAtZero: true
        },
        y: {
          title: { display: true, text: 'Valor Total (AOA)' },
          beginAtZero: true
        }
      }
    }
  });

  // 10. Scatter Chart - Distribution
  new Chart(document.getElementById('scatterChart'), {
    type: 'scatter',
    data: {
      datasets: [{
        label: 'Clientes',
        data: topCustomers.map((c, i) => ({
          x: i + 1,
          y: c.total
        })),
        backgroundColor: '#20c997'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        x: {
          title: { display: true, text: 'Ranking' },
          beginAtZero: true
        },
        y: {
          title: { display: true, text: 'Valor Total (AOA)' },
          beginAtZero: true
        }
      }
    }
  });
</script>
