<!DOCTYPE html>
<html>
<head>
  <meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background-color: #dc3545; color: white; padding: 20px; text-align: center; border-radius: 5px 5px 0 0; }
    .content { background-color: #f8f9fa; padding: 20px; border: 1px solid #dee2e6; }
    .alert-box { background-color: #fff3cd; border: 1px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px; }
    .info-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    .info-table th { background-color: #e9ecef; padding: 10px; text-align: left; border: 1px solid #dee2e6; }
    .info-table td { padding: 10px; border: 1px solid #dee2e6; }
    .danger-text { color: #dc3545; font-weight: bold; }
    .success-text { color: #28a745; font-weight: bold; }
    .footer { background-color: #343a40; color: white; padding: 15px; text-align: center; font-size: 12px; border-radius: 0 0 5px 5px; }
    .btn { display: inline-block; padding: 10px 20px; background-color: #007bff; color: white !important; text-decoration: none; border-radius: 5px; margin: 10px 0; }
    ul { margin: 10px 0; padding-left: 20px; }
    li { margin: 5px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 style="margin: 0;">‚ö†Ô∏è ALERTA DE PRE√áO</h1>
      <p style="margin: 10px 0 0 0;">Documento com margem de lucro abaixo do configurado</p>
    </div>

    <div class="content">
      <h2>Informa√ß√µes do Documento</h2>

      <table class="info-table">
        <tr>
          <th>Tipo de Documento</th>
          <td><%= @document_type %></td>
        </tr>
        <tr>
          <th>N√∫mero</th>
          <td><strong><%= @document_number %></strong></td>
        </tr>
        <tr>
          <th>Cliente</th>
          <td><%= @document.customer.name %></td>
        </tr>
        <tr>
          <th>Valor Total</th>
          <td><%= number_to_currency(@document.total_value, unit: 'AOA ', separator: ',', delimiter: '.') %></td>
        </tr>
        <tr>
          <th>Criado por</th>
          <td><%= @document.created_by_user&.name || 'Sistema' %></td>
        </tr>
      </table>

      <div class="alert-box">
        <h3 style="margin-top: 0;">üìä An√°lise de Margem de Lucro</h3>

        <table class="info-table">
          <tr>
            <th>Margem Esperada</th>
            <td class="success-text"><%= number_to_percentage(@warning.expected_margin, precision: 0) %></td>
          </tr>
          <tr>
            <th>Margem Real</th>
            <td class="<%= @warning.actual_margin < @warning.expected_margin ? 'danger-text' : 'success-text' %>">
              <%= number_to_percentage(@warning.actual_margin, precision: 2) %>
            </td>
          </tr>
          <tr>
            <th>D√©fice de Margem</th>
            <td class="danger-text"><%= number_to_percentage(@warning.margin_deficit, precision: 2) %></td>
          </tr>
          <tr>
            <th>Perda Estimada de Lucro</th>
            <td class="danger-text"><%= number_to_currency(@warning.profit_loss, unit: 'AOA ', separator: ',', delimiter: '.') %></td>
          </tr>
        </table>
      </div>

      <% if @warning.item_breakdown.present? && @warning.item_breakdown['below_margin_items'].present? %>
        <h3>üîç Itens Abaixo da Margem</h3>
        <ul>
          <% @warning.item_breakdown['below_margin_items'].each do |item| %>
            <li>
              <strong><%= item['product_name'] %></strong>:
              Margem de <%= item['margin_percentage'] %>%
              (abaixo de <%= @warning.expected_margin %>%)
              - Perda: <%= number_to_currency(item['profit_loss'], unit: 'AOA ', separator: ',', delimiter: '.') %>
            </li>
          <% end %>
        </ul>
      <% end %>

      <% if @document.discount_justification.present? %>
        <h3>üìù Justifica√ß√£o do Desconto</h3>
        <div style="background-color: white; padding: 15px; border-left: 4px solid #ffc107; margin: 15px 0;">
          <%= simple_format(@document.discount_justification) %>
        </div>
      <% end %>

      <div style="text-align: center; margin: 20px 0;">
        <% url = @document.is_a?(Estimate) ? estimate_url(@document) : invoice_url(@document) %>
        <a href="<%= url %>" class="btn">Ver Documento Completo</a>
      </div>

      <p style="font-size: 12px; color: #6c757d; margin-top: 20px;">
        <strong>Nota:</strong> Este email foi gerado automaticamente pelo sistema de precifica√ß√£o inteligente.
        O documento em PDF est√° anexado a este email para sua refer√™ncia.
      </p>
    </div>

    <div class="footer">
      <p style="margin: 0;">CRM 3K - Sistema de Gest√£o</p>
      <p style="margin: 5px 0 0 0;">Email autom√°tico - N√£o responda a esta mensagem</p>
    </div>
  </div>
</body>
</html>
