<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1>
        <i class="bi bi-printer"></i> <%= @job.job_number %>
        <span class="badge bg-<%= @job.status_color %>"><%= @job.status.humanize %></span>
        <% if @job.overdue? %>
          <span class="badge bg-danger"><i class="bi bi-exclamation-triangle"></i> Atrasado</span>
        <% end %>
      </h1>
      <h3 class="text-muted"><%= @job.title %></h3>
    </div>
    <div class="col-auto">
      <%= link_to edit_job_path(@job), class: 'btn btn-warning' do %>
        <i class="bi bi-pencil"></i> Editar
      <% end %>
    </div>
  </div>

  <!-- Status Change Buttons -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> Atualizar Status</h5>
    </div>
    <div class="card-body">
      <div class="btn-group" role="group">
        <%= link_to update_status_job_path(@job, new_status: 'novo'), data: { turbo_method: :patch }, class: "btn btn-outline-primary #{'active' if @job.status == 'novo'}" do %>
          Novo
        <% end %>
        <%= link_to update_status_job_path(@job, new_status: 'em_design'), data: { turbo_method: :patch }, class: "btn btn-outline-info #{'active' if @job.status == 'em_design'}" do %>
          Design
        <% end %>
        <%= link_to update_status_job_path(@job, new_status: 'em_impressao'), data: { turbo_method: :patch }, class: "btn btn-outline-warning #{'active' if @job.status == 'em_impressao'}" do %>
          Impressão
        <% end %>
        <%= link_to update_status_job_path(@job, new_status: 'em_acabamento'), data: { turbo_method: :patch }, class: "btn btn-outline-warning #{'active' if @job.status == 'em_acabamento'}" do %>
          Acabamento
        <% end %>
        <%= link_to update_status_job_path(@job, new_status: 'pronto'), data: { turbo_method: :patch }, class: "btn btn-outline-success #{'active' if @job.status == 'pronto'}" do %>
          Pronto
        <% end %>
        <%= link_to update_status_job_path(@job, new_status: 'entregue'), data: { turbo_method: :patch }, class: "btn btn-outline-secondary #{'active' if @job.status == 'entregue'}" do %>
          Entregue
        <% end %>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="card mb-3">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informações</h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-5">Cliente:</dt>
            <dd class="col-sm-7"><%= link_to @job.customer.name, @job.customer %></dd>

            <dt class="col-sm-5">Prioridade:</dt>
            <dd class="col-sm-7">
              <span class="badge bg-<%= @job.priority == 'urgente' ? 'danger' : @job.priority == 'alta' ? 'warning' : 'secondary' %>">
                <%= @job.priority.capitalize %>
              </span>
            </dd>

            <dt class="col-sm-5">Data Criação:</dt>
            <dd class="col-sm-7"><%= @job.created_at.strftime('%d/%m/%Y %H:%M') %></dd>

            <% if @job.delivery_date %>
              <dt class="col-sm-5">Entrega:</dt>
              <dd class="col-sm-7">
                <span class="badge bg-<%= @job.overdue? ? 'danger' : 'info' %>">
                  <%= @job.delivery_date.strftime('%d/%m/%Y') %>
                </span>
              </dd>
            <% end %>

            <dt class="col-sm-5">Valor Total:</dt>
            <dd class="col-sm-7"><strong><%= number_to_currency(@job.total_value, unit: "AOA") %></strong></dd>

            <dt class="col-sm-5">Sinal Pago:</dt>
            <dd class="col-sm-7"><%= number_to_currency(@job.advance_paid, unit: "AOA") %></dd>

            <dt class="col-sm-5">Saldo:</dt>
            <dd class="col-sm-7">
              <strong class="text-<%= @job.balance > 0 ? 'danger' : 'success' %>">
                <%= number_to_currency(@job.balance, unit: "AOA") %>
              </strong>
            </dd>
          </dl>

          <% if @job.description.present? %>
            <hr>
            <strong>Descrição:</strong>
            <p class="mb-0"><%= simple_format(@job.description) %></p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="bi bi-list"></i> Items do Trabalho</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Produto</th>
                  <th class="text-center">Quantidade</th>
                  <th class="text-end">Preço Unitário</th>
                  <th class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                <% @job_items.each do |item| %>
                  <tr>
                    <td><%= item.product.name %></td>
                    <td class="text-center"><%= item.quantity %></td>
                    <td class="text-end"><%= number_to_currency(item.unit_price, unit: "AOA") %></td>
                    <td class="text-end"><strong><%= number_to_currency(item.subtotal, unit: "AOA") %></strong></td>
                  </tr>
                <% end %>
              </tbody>
              <tfoot>
                <tr class="table-light">
                  <th colspan="3" class="text-end">Total:</th>
                  <th class="text-end">
                    <h4 class="text-primary mb-0"><%= number_to_currency(@job.total_value, unit: "AOA") %></h4>
                  </th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
