<%= form_with(model: product, local: true) do |form| %>
  <% if product.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(product.errors.count, "erro") %> impediram que este produto fosse guardado:</h5>
      <ul class="mb-0">
        <% product.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-6">
      <div class="mb-3">
        <%= form.label :name, 'Nome do Produto/Serviço', class: 'form-label' %>
        <%= form.text_field :name, class: 'form-control', required: true %>
      </div>
    </div>

    <div class="col-md-3">
      <div class="mb-3">
        <%= form.label :category, 'Categoria', class: 'form-label' %>
        <%= form.select :category,
            [['Gráfica', 'grafica'], ['Cyber Café', 'lanhouse'], ['Ambos', 'ambos']],
            {},
            class: 'form-select',
            required: true %>
        <small class="form-text text-muted">Onde este produto/serviço é usado</small>
      </div>
    </div>

    <div class="col-md-3">
      <div class="mb-3">
        <%= form.label :active, 'Status', class: 'form-label' %>
        <%= form.select :active,
            [['Ativo', true], ['Inativo', false]],
            {},
            class: 'form-select' %>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="mb-3">
        <%= form.label :unit, 'Unidade de Medida', class: 'form-label' %>
        <%= form.text_field :unit, class: 'form-control', required: true, placeholder: 'Ex: unidade, hora, página, metro' %>
        <small class="form-text text-muted">Como este produto/serviço é medido</small>
      </div>
    </div>

    <div class="col-md-6">
      <div class="mb-3">
        <%= form.label :base_price, 'Preço Base', class: 'form-label' %>
        <div class="input-group">
          <span class="input-group-text">AOA</span>
          <%= form.number_field :base_price, class: 'form-control', step: '0.01', min: '0', required: true %>
        </div>
        <small class="form-text text-muted">Preço padrão por unidade</small>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0"><i class="bi bi-calculator"></i> Custos para Precificação por Margem de Contribuição (Opcional)</h6>
    </div>
    <div class="card-body">
      <p class="text-muted small mb-3">
        <i class="bi bi-info-circle"></i> <strong>Margem de Contribuição:</strong> PV = CV ÷ (1 - MC%). Configure os custos variáveis abaixo.
      </p>

      <h6 class="text-primary"><i class="bi bi-cash-stack"></i> Custos Variáveis Fixos (AOA)</h6>
      <div class="row">
        <div class="col-md-3">
          <div class="mb-3">
            <%= form.label :labor_cost, 'Mão de Obra', class: 'form-label' %>
            <div class="input-group input-group-sm">
              <span class="input-group-text">AOA</span>
              <%= form.number_field :labor_cost, class: 'form-control', step: '0.01', min: '0', value: product.labor_cost || 0 %>
            </div>
            <small class="form-text text-muted">Custo de trabalho</small>
          </div>
        </div>

        <div class="col-md-3">
          <div class="mb-3">
            <%= form.label :material_cost, 'Matéria-Prima', class: 'form-label' %>
            <div class="input-group input-group-sm">
              <span class="input-group-text">AOA</span>
              <%= form.number_field :material_cost, class: 'form-control', step: '0.01', min: '0', value: product.material_cost || 0 %>
            </div>
            <small class="form-text text-muted">Materiais e insumos</small>
          </div>
        </div>

        <div class="col-md-3">
          <div class="mb-3">
            <%= form.label :purchase_price, 'Preço de Compra', class: 'form-label' %>
            <div class="input-group input-group-sm">
              <span class="input-group-text">AOA</span>
              <%= form.number_field :purchase_price, class: 'form-control', step: '0.01', min: '0', value: product.purchase_price || 0 %>
            </div>
            <small class="form-text text-muted">Preço de aquisição</small>
          </div>
        </div>

        <div class="col-md-3">
          <div class="mb-3">
            <%= form.label :packaging_cost, 'Embalagem', class: 'form-label' %>
            <div class="input-group input-group-sm">
              <span class="input-group-text">AOA</span>
              <%= form.number_field :packaging_cost, class: 'form-control', step: '0.01', min: '0', value: product.packaging_cost || 0 %>
            </div>
            <small class="form-text text-muted">Custo de embalagem</small>
          </div>
        </div>
      </div>

      <hr>

      <h6 class="text-warning"><i class="bi bi-percent"></i> Custos Variáveis Percentuais (%)</h6>
      <div class="row">
        <div class="col-md-4">
          <div class="mb-3">
            <%= form.label :sales_commission_percentage, 'Comissão de Vendas', class: 'form-label' %>
            <div class="input-group input-group-sm">
              <%= form.number_field :sales_commission_percentage, class: 'form-control', step: '0.01', min: '0', max: '100', value: product.sales_commission_percentage || 0 %>
              <span class="input-group-text">%</span>
            </div>
            <small class="form-text text-muted">% sobre o preço de venda</small>
          </div>
        </div>

        <div class="col-md-4">
          <div class="mb-3">
            <%= form.label :sales_tax_percentage, 'Impostos sobre Vendas', class: 'form-label' %>
            <div class="input-group input-group-sm">
              <%= form.number_field :sales_tax_percentage, class: 'form-control', step: '0.01', min: '0', max: '100', value: product.sales_tax_percentage || 0 %>
              <span class="input-group-text">%</span>
            </div>
            <small class="form-text text-muted">IVA, INSS, etc.</small>
          </div>
        </div>

        <div class="col-md-4">
          <div class="mb-3">
            <%= form.label :card_fee_percentage, 'Taxa de Cartão', class: 'form-label' %>
            <div class="input-group input-group-sm">
              <%= form.number_field :card_fee_percentage, class: 'form-control', step: '0.01', min: '0', max: '100', value: product.card_fee_percentage || 0 %>
              <span class="input-group-text">%</span>
            </div>
            <small class="form-text text-muted">Taxa de máquina de cartão</small>
          </div>
        </div>
      </div>

      <% if product.persisted? && product.has_cost_data? %>
        <div class="alert alert-success">
          <% breakdown = product.pricing_breakdown %>
          <div class="row align-items-center">
            <div class="col-md-6">
              <strong><i class="bi bi-check-circle"></i> Preço Sugerido (Margem de Contribuição):</strong>
              <h4 class="mb-0"><%= number_to_currency(product.suggested_price, unit: 'AOA', separator: ',', delimiter: '.') %></h4>
            </div>
            <div class="col-md-6">
              <small class="d-block">
                <strong>CV Total:</strong> <%= number_to_currency(breakdown[:total_variable_costs], unit: 'AOA', separator: ',', delimiter: '.') %><br>
                <strong>MCu:</strong> <%= number_to_currency(breakdown[:contribution_margin_amount], unit: 'AOA', separator: ',', delimiter: '.') %>
                (<%= number_with_precision(breakdown[:actual_contribution_margin_percentage], precision: 1) %>%)
              </small>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="alert alert-info">
    <i class="bi bi-info-circle"></i> <strong>Dica:</strong> Após criar o produto, você pode adicionar regras de preço para descontos por quantidade na página de detalhes.
  </div>

  <div class="d-flex gap-2">
    <%= form.submit 'Guardar', class: 'btn btn-primary' %>
    <%= link_to 'Cancelar', product.persisted? ? product : products_path, class: 'btn btn-secondary' %>
  </div>
<% end %>
