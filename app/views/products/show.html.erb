<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1><i class="bi bi-box"></i> <%= @product.name %></h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to 'Painel', root_path %></li>
          <li class="breadcrumb-item"><%= link_to 'Produtos', products_path %></li>
          <li class="breadcrumb-item active"><%= @product.name %></li>
        </ol>
      </nav>
    </div>
    <div class="col-auto">
      <%= link_to edit_product_path(@product), class: 'btn btn-warning' do %>
        <i class="bi bi-pencil"></i> Editar
      <% end %>
      <%= link_to @product, data: { turbo_method: :delete, turbo_confirm: 'Tem a certeza?' }, class: 'btn btn-danger' do %>
        <i class="bi bi-trash"></i> Eliminar
      <% end %>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informação do Produto</h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-4">Categoria:</dt>
            <dd class="col-sm-8">
              <% if @product.category == 'grafica' %>
                <span class="badge bg-primary"><i class="bi bi-printer"></i> Gráfica</span>
              <% elsif @product.category == 'lanhouse' %>
                <span class="badge bg-info"><i class="bi bi-pc-display"></i> Cyber Café</span>
              <% else %>
                <span class="badge bg-success"><i class="bi bi-star"></i> Ambos</span>
              <% end %>
            </dd>

            <dt class="col-sm-4">Unidade:</dt>
            <dd class="col-sm-8"><%= @product.unit %></dd>

            <dt class="col-sm-4">Preço Base:</dt>
            <dd class="col-sm-8">
              <h4 class="text-primary mb-0">
                <%= number_to_currency(@product.base_price, unit: "AOA") %>
                <small class="text-muted">/ <%= @product.unit %></small>
              </h4>
            </dd>

            <dt class="col-sm-4">Status:</dt>
            <dd class="col-sm-8">
              <% if @product.active %>
                <span class="badge bg-success">Ativo</span>
              <% else %>
                <span class="badge bg-secondary">Inativo</span>
              <% end %>
            </dd>
          </dl>
        </div>
        <div class="card-footer text-muted">
          <small>Criado em <%= @product.created_at.strftime('%d/%m/%Y') %></small>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-tag"></i> Regras de Preço por Quantidade</h5>
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newPriceRuleModal">
            <i class="bi bi-plus"></i> Nova Regra
          </button>
        </div>
        <div class="card-body">
          <% if @price_rules.any? %>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Quantidade Mínima</th>
                    <th>Quantidade Máxima</th>
                    <th class="text-end">Preço Unitário</th>
                    <th class="text-end">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <% @price_rules.each do |rule| %>
                    <tr>
                      <td><%= rule.min_qty %></td>
                      <td><%= rule.max_qty || 'Sem limite' %></td>
                      <td class="text-end">
                        <strong><%= number_to_currency(rule.unit_price, unit: "AOA") %></strong>
                      </td>
                      <td class="text-end">
                        <%= link_to product_price_rule_path(@product, rule), data: { turbo_method: :delete, turbo_confirm: 'Tem a certeza?' }, class: 'btn btn-sm btn-outline-danger' do %>
                          <i class="bi bi-trash"></i>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>

            <div class="alert alert-info mt-3">
              <i class="bi bi-calculator"></i> <strong>Exemplo de Preços:</strong><br>
              <ul class="mb-0">
                <li>1-9 <%= @product.unit %>: <%= number_to_currency(@product.price_for_quantity(1), unit: "AOA") %></li>
                <li>10-49 <%= @product.unit %>: <%= number_to_currency(@product.price_for_quantity(10), unit: "AOA") %></li>
                <li>50+ <%= @product.unit %>: <%= number_to_currency(@product.price_for_quantity(50), unit: "AOA") %></li>
              </ul>
            </div>
          <% else %>
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle"></i> Nenhuma regra de preço definida. O preço base será usado para todas as quantidades.
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for New Price Rule -->
<div class="modal fade" id="newPriceRuleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <%= form_with url: product_price_rules_path(@product), data: { turbo_method: :post }, local: true do |f| %>
        <div class="modal-header">
          <h5 class="modal-title">Nova Regra de Preço</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <%= f.label :min_qty, 'Quantidade Mínima', class: 'form-label' %>
            <%= f.number_field :min_qty, class: 'form-control', min: 1, required: true %>
          </div>
          <div class="mb-3">
            <%= f.label :max_qty, 'Quantidade Máxima', class: 'form-label' %>
            <%= f.number_field :max_qty, class: 'form-control', min: 1 %>
            <small class="form-text text-muted">Deixe em branco para sem limite</small>
          </div>
          <div class="mb-3">
            <%= f.label :unit_price, 'Preço Unitário', class: 'form-label' %>
            <div class="input-group">
              <span class="input-group-text">AOA</span>
              <%= f.number_field :unit_price, class: 'form-control', step: '0.01', min: '0', required: true %>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <%= f.submit 'Criar Regra', class: 'btn btn-primary' %>
        </div>
      <% end %>
    </div>
  </div>
</div>
