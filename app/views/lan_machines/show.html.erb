<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1><i class="bi bi-pc-display"></i> <%= @lan_machine.name %></h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to 'Cyber Café', lan_machines_path %></li>
          <li class="breadcrumb-item"><%= link_to 'Máquinas', lan_machines_path %></li>
          <li class="breadcrumb-item active" aria-current="page"><%= @lan_machine.name %></li>
        </ol>
      </nav>
    </div>
    <div class="col-auto">
      <%= link_to edit_lan_machine_path(@lan_machine), class: 'btn btn-primary me-2' do %>
        <i class="bi bi-pencil"></i> Editar
      <% end %>
      <%= link_to lan_machines_path, class: 'btn btn-secondary' do %>
        <i class="bi bi-arrow-left"></i> Voltar
      <% end %>
    </div>
  </div>

  <!-- Machine Info Card -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informações da Máquina</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tbody>
              <tr>
                <th width="40%">Nome:</th>
                <td><strong><%= @lan_machine.name %></strong></td>
              </tr>
              <tr>
                <th>Status:</th>
                <td>
                  <% case @lan_machine.status %>
                  <% when 'livre' %>
                    <span class="badge bg-success">Livre</span>
                  <% when 'ocupado' %>
                    <span class="badge bg-danger">Ocupado</span>
                  <% when 'avariado' %>
                    <span class="badge bg-warning">Avariado</span>
                  <% when 'reservado' %>
                    <span class="badge bg-info">Reservado</span>
                  <% end %>
                </td>
              </tr>
              <tr>
                <th>Tarifa por Hora:</th>
                <td><strong><%= number_to_currency(@lan_machine.hourly_rate, unit: "AOA", separator: ",", delimiter: ".") %></strong></td>
              </tr>
              <tr>
                <th>Total de Sessões:</th>
                <td><%= @lan_machine.lan_sessions.count %></td>
              </tr>
              <% if @lan_machine.notes.present? %>
                <tr>
                  <th>Notas:</th>
                  <td><%= @lan_machine.notes %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Current Session Card -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header <%= @current_session ? 'bg-danger text-white' : 'bg-light' %>">
          <h5 class="mb-0"><i class="bi bi-circle-fill"></i> Sessão Atual</h5>
        </div>
        <div class="card-body">
          <% if @current_session %>
            <div data-controller="session-timer"
                 data-session-timer-start-time-value="<%= @current_session.start_time.iso8601 %>"
                 data-session-timer-hourly-rate-value="<%= @lan_machine.hourly_rate %>"
                 data-session-timer-session-id-value="<%= @current_session.id %>"
                 data-session-timer-status-value="<%= @current_session.status %>">

              <div class="mb-3">
                <strong>Cliente:</strong>
                <%= @current_session.customer&.name || '<span class="text-muted">Anônimo</span>'.html_safe %>
              </div>

              <div class="mb-3">
                <strong>Início:</strong>
                <%= @current_session.start_time.strftime('%d/%m/%Y às %H:%M') %>
              </div>

              <div class="mb-3">
                <strong>Tempo Decorrido:</strong>
                <span class="badge bg-info fs-5" data-session-timer-target="elapsedTime">
                  <%= @current_session.formatted_elapsed_time %>
                </span>
              </div>

              <div class="mb-3">
                <strong>Valor Atual:</strong>
                <div class="fs-3 text-success" data-session-timer-target="currentValue">
                  <%= number_to_currency(@current_session.current_value, unit: "AOA", separator: ",", delimiter: ".") %>
                </div>
              </div>

              <div class="mb-3">
                <strong>Tipo de Cobrança:</strong>
                <span class="badge bg-secondary"><%= @current_session.billing_type || 'Pós-pago' %></span>
              </div>

              <div class="mt-4">
                <%= link_to close_lan_session_path(@current_session),
                    data: { turbo_method: :post, turbo_confirm: 'Tem certeza que deseja fechar esta sessão?' },
                    class: 'btn btn-danger w-100' do %>
                  <i class="bi bi-stop-circle"></i> Fechar Sessão
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="text-center py-4 text-muted">
              <i class="bi bi-circle fs-1"></i>
              <p class="mt-2 mb-0">Nenhuma sessão ativa</p>
              <% if @lan_machine.available? %>
                <p class="small">Máquina disponível para nova sessão</p>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Sessions -->
  <div class="card">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="bi bi-clock-history"></i> Histórico de Sessões</h5>
    </div>
    <div class="card-body p-0">
      <% if @recent_sessions.any? %>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Início</th>
                <th>Fim</th>
                <th>Duração</th>
                <th>Status</th>
                <th class="text-end">Valor</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody>
              <% @recent_sessions.each do |session| %>
                <tr>
                  <td><%= session.customer&.name || '<span class="text-muted">Anônimo</span>'.html_safe %></td>
                  <td><%= session.start_time.strftime('%d/%m/%Y %H:%M') %></td>
                  <td>
                    <% if session.end_time %>
                      <%= session.end_time.strftime('%d/%m/%Y %H:%M') %>
                    <% else %>
                      <span class="badge bg-success">Em andamento</span>
                    <% end %>
                  </td>
                  <td>
                    <% if session.status == 'fechada' %>
                      <%= session.total_minutes %> min
                    <% else %>
                      <%= session.formatted_elapsed_time %>
                    <% end %>
                  </td>
                  <td>
                    <% case session.status %>
                    <% when 'aberta' %>
                      <span class="badge bg-success">Ativa</span>
                    <% when 'fechada' %>
                      <span class="badge bg-secondary">Fechada</span>
                    <% when 'cancelada' %>
                      <span class="badge bg-danger">Cancelada</span>
                    <% end %>
                  </td>
                  <td class="text-end">
                    <strong>
                      <%= number_to_currency(
                        session.status == 'fechada' ? session.total_value : session.current_value,
                        unit: "AOA",
                        separator: ",",
                        delimiter: "."
                      ) %>
                    </strong>
                  </td>
                  <td class="text-end">
                    <%= link_to lan_session_path(session), class: 'btn btn-sm btn-outline-primary' do %>
                      <i class="bi bi-eye"></i>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted p-3 mb-0">Nenhuma sessão registrada para esta máquina</p>
      <% end %>
    </div>
    <% if @recent_sessions.count >= 10 %>
      <div class="card-footer">
        <%= link_to 'Ver todas as sessões', lan_sessions_path, class: 'btn btn-sm btn-outline-secondary w-100' %>
      </div>
    <% end %>
  </div>
</div>
