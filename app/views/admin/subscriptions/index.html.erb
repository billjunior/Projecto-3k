<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1><i class="bi bi-credit-card"></i> Gestão de Subscrições</h1>
      <p class="text-muted">Gerir subscrições e pagamentos de todos os tenants</p>
    </div>
  </div>

  <!-- Estatísticas -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body text-center">
          <h6>Total de Tenants</h6>
          <h2><%= @total_tenants %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body text-center">
          <h6>Subscrições Ativas</h6>
          <h2><%= @active_count %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body text-center">
          <h6>Em Período de Trial</h6>
          <h2><%= @trial_count %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-danger text-white">
        <div class="card-body text-center">
          <h6>Expiradas</h6>
          <h2><%= @expired_count %></h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: admin_subscriptions_path, method: :get, local: true, class: 'd-flex gap-2 flex-wrap align-items-end' do |f| %>
        <div style="min-width: 200px;">
          <%= f.label :status, 'Status', class: 'form-label small' %>
          <%= f.select :status,
              [
                ['Todos', ''],
                ['Ativo', 'active'],
                ['Trial', 'trial'],
                ['Expirado', 'expired'],
                ['Suspenso', 'suspended']
              ],
              { selected: params[:status] },
              class: 'form-select form-select-sm' %>
        </div>
        <div>
          <%= f.check_box :expiring_soon, {}, 'true', 'false' %>
          <%= f.label :expiring_soon, 'Expira em 7 dias', class: 'form-check-label small' %>
        </div>
        <div>
          <%= f.submit 'Filtrar', class: 'btn btn-primary btn-sm' %>
          <%= link_to 'Limpar', admin_subscriptions_path, class: 'btn btn-outline-secondary btn-sm' %>
        </div>
      <% end %>
    </div>
  </div>

  <% if @expiring_soon_count > 0 %>
    <div class="alert alert-warning">
      <i class="bi bi-exclamation-triangle-fill"></i>
      <strong><%= @expiring_soon_count %> subscrições</strong> expiram nos próximos 7 dias!
    </div>
  <% end %>

  <!-- Tabela de Tenants -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Empresa</th>
              <th>Subdomínio</th>
              <th>Status</th>
              <th>Plano</th>
              <th>Expira em</th>
              <th>Dias Restantes</th>
              <th>Último Pagamento</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody>
            <% @tenants.each do |tenant| %>
              <tr class="<%= 'table-danger' if tenant.subscription_status == 'expired' %> <%= 'table-warning' if tenant.expiring_soon?(7) %>">
                <td>
                  <strong><%= tenant.name %></strong><br>
                  <small class="text-muted"><%= tenant.company_setting&.company_name %></small>
                </td>
                <td><code><%= tenant.subdomain %></code></td>
                <td>
                  <span class="badge <%= tenant.subscription_badge_class %>">
                    <%= tenant.subscription_status.capitalize %>
                  </span>
                </td>
                <td><%= tenant.plan_name %></td>
                <td>
                  <% if tenant.subscription_expires_at %>
                    <%= tenant.subscription_expires_at.strftime('%d/%m/%Y') %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% days = tenant.days_remaining %>
                  <span class="badge <%= days <= 0 ? 'bg-danger' : days <= 7 ? 'bg-warning text-dark' : 'bg-secondary' %>">
                    <%= days %> dias
                  </span>
                </td>
                <td>
                  <% if tenant.last_payment_date %>
                    <%= tenant.last_payment_date.strftime('%d/%m/%Y') %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm">
                    <!-- Renovar -->
                    <div class="dropdown">
                      <button class="btn btn-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-arrow-clockwise"></i> Renovar
                      </button>
                      <ul class="dropdown-menu">
                        <li>
                          <%= link_to '1 mês', renew_admin_subscription_path(tenant, months: 1),
                              method: :post, class: 'dropdown-item',
                              data: { turbo_method: :post } %>
                        </li>
                        <li>
                          <%= link_to '3 meses (-10%)', renew_admin_subscription_path(tenant, months: 3),
                              method: :post, class: 'dropdown-item',
                              data: { turbo_method: :post } %>
                        </li>
                        <li>
                          <%= link_to '6 meses (-15%)', renew_admin_subscription_path(tenant, months: 6),
                              method: :post, class: 'dropdown-item',
                              data: { turbo_method: :post } %>
                        </li>
                        <li>
                          <%= link_to '12 meses (-20%)', renew_admin_subscription_path(tenant, months: 12),
                              method: :post, class: 'dropdown-item',
                              data: { turbo_method: :post } %>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <%= link_to 'Trial 30 dias', grant_trial_admin_subscription_path(tenant, days: 30),
                              method: :post, class: 'dropdown-item',
                              data: { turbo_method: :post } %>
                        </li>
                      </ul>
                    </div>

                    <!-- Suspender/Ativar -->
                    <% if tenant.subscription_status == 'suspended' %>
                      <%= link_to activate_admin_subscription_path(tenant),
                          method: :post, class: 'btn btn-info btn-sm',
                          data: { turbo_method: :post, turbo_confirm: "Ativar #{tenant.name}?" } do %>
                        <i class="bi bi-play-circle"></i> Ativar
                      <% end %>
                    <% else %>
                      <%= link_to suspend_admin_subscription_path(tenant),
                          method: :post, class: 'btn btn-warning btn-sm',
                          data: { turbo_method: :post, turbo_confirm: "Suspender #{tenant.name}? Os usuários não poderão acessar o sistema." } do %>
                        <i class="bi bi-pause-circle"></i> Suspender
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="mt-3 d-flex justify-content-center">
        <%= paginate @tenants %>
      </div>
    </div>
  </div>

  <!-- Legenda -->
  <div class="card mt-4 bg-light">
    <div class="card-body">
      <h6><i class="bi bi-info-circle"></i> Informações:</h6>
      <ul class="mb-0 small">
        <li><strong>Trial:</strong> Período de teste gratuito de 30 dias</li>
        <li><strong>Ativo:</strong> Subscrição paga e válida</li>
        <li><strong>Expirado:</strong> Subscrição vencida - acesso bloqueado</li>
        <li><strong>Suspenso:</strong> Bloqueado manualmente pelo administrador</li>
        <li><strong>Preços:</strong> Mensal 50.000 AOA | Trimestral 135.000 AOA (-10%) | Semestral 255.000 AOA (-15%) | Anual 480.000 AOA (-20%)</li>
      </ul>
    </div>
  </div>
</div>
