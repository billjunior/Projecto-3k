<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1><i class="bi bi-mortarboard"></i> Cursos de Formação Profissional</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to 'Cyber Café', lan_machines_path %></li>
          <li class="breadcrumb-item active">Cursos de Formação</li>
        </ol>
      </nav>
    </div>
    <div class="col-auto">
      <%= link_to new_training_course_path, class: 'btn btn-primary' do %>
        <i class="bi bi-plus-circle"></i> Novo Curso
      <% end %>
    </div>
  </div>

  <!-- Filtro de Mês/Ano -->
  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: training_courses_path, method: :get, class: 'row g-3 align-items-end' do |f| %>
        <div class="col-md-4">
          <label class="form-label">Mês</label>
          <%= select_tag :month, options_for_select(opcoes_meses, @month), class: 'form-select' %>
        </div>
        <div class="col-md-4">
          <label class="form-label">Ano</label>
          <%= select_tag :year, options_for_select((Date.today.year - 14..Date.today.year + 1).to_a.reverse, @year), class: 'form-select' %>
        </div>
        <div class="col-md-4">
          <%= submit_tag 'Filtrar', class: 'btn btn-primary w-100' %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Estatísticas Mensais -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body text-center">
          <h6>Valor Total</h6>
          <h3><%= number_to_currency(@total_value, unit: 'AOA', separator: ',', delimiter: '.') %></h3>
          <small>Cursos do mês</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body text-center">
          <h6>Total Pago</h6>
          <h3><%= number_to_currency(@total_paid, unit: 'AOA', separator: ',', delimiter: '.') %></h3>
          <small><%= ((@total_paid.to_f / @total_value * 100).round(1) if @total_value > 0) || 0 %>% recebido</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-dark">
        <div class="card-body text-center">
          <h6>Saldo Pendente</h6>
          <h3><%= number_to_currency(@total_balance, unit: 'AOA', separator: ',', delimiter: '.') %></h3>
          <small>A receber</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body text-center">
          <h6>Cursos</h6>
          <h3><%= @active_courses %> / <%= @completed_courses %></h3>
          <small>Activos / Concluídos</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabela de Cursos -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-table"></i> FORMAÇÕES DE <%= nome_mes(@month).upcase %> <%= @year %>
      </h5>
    </div>
    <div class="card-body">
      <% if @training_courses.any? %>
        <div class="table-responsive">
          <table class="table table-bordered table-hover table-sm">
            <thead class="table-dark">
              <tr>
                <th style="width: 200px;">Formando</th>
                <th>Módulo</th>
                <th style="width: 100px;" class="text-center">Dias</th>
                <th style="width: 100px;">Início</th>
                <th style="width: 100px;">Fim</th>
                <th style="width: 120px;" class="text-end">Valor Total</th>
                <th style="width: 120px;" class="text-end">Pago</th>
                <th style="width: 120px;" class="text-end">Saldo</th>
                <th style="width: 100px;" class="text-center">Pagamento</th>
                <th style="width: 100px;" class="text-center">Estado</th>
                <th style="width: 120px;" class="text-center">Acções</th>
              </tr>
            </thead>
            <tbody>
              <% @training_courses.each do |course| %>
                <tr>
                  <td>
                    <strong><%= course.student_name %></strong>
                  </td>
                  <td>
                    <%= course.module_name %>
                    <% if course.notes.present? %>
                      <br><small class="text-muted"><%= truncate(course.notes, length: 40) %></small>
                    <% end %>
                  </td>
                  <td class="text-center">
                    <%= course.training_days || '-' %>
                  </td>
                  <td>
                    <%= course.start_date.strftime('%d/%m/%Y') if course.start_date %>
                  </td>
                  <td>
                    <%= course.end_date.strftime('%d/%m/%Y') if course.end_date %>
                  </td>
                  <td class="text-end">
                    <% if course.total_value.present? %>
                      <%= number_to_currency(course.total_value, unit: 'AOA', separator: ',', delimiter: '.') %>
                    <% else %>
                      -
                    <% end %>
                  </td>
                  <td class="text-end">
                    <% if course.amount_paid.present? && course.amount_paid > 0 %>
                      <span class="text-success fw-bold">
                        <%= number_to_currency(course.amount_paid, unit: 'AOA', separator: ',', delimiter: '.') %>
                      </span>
                      <% if course.total_value && course.total_value > 0 %>
                        <br><small class="text-muted"><%= course.payment_percentage %>%</small>
                      <% end %>
                    <% else %>
                      -
                    <% end %>
                  </td>
                  <td class="text-end">
                    <% balance = course.balance %>
                    <% if balance > 0 %>
                      <span class="text-danger fw-bold">
                        <%= number_to_currency(balance, unit: 'AOA', separator: ',', delimiter: '.') %>
                      </span>
                    <% elsif balance == 0 %>
                      <span class="text-success">-</span>
                    <% else %>
                      <%= number_to_currency(balance, unit: 'AOA', separator: ',', delimiter: '.') %>
                    <% end %>
                  </td>
                  <td class="text-center">
                    <% if course.manual? %>
                      <span class="badge bg-primary">Manual</span>
                    <% else %>
                      <span class="badge bg-success">Transferência</span>
                    <% end %>
                  </td>
                  <td class="text-center">
                    <% if course.active? %>
                      <span class="badge bg-info">Activo</span>
                    <% elsif course.completed? %>
                      <span class="badge bg-success">Concluído</span>
                    <% else %>
                      <span class="badge bg-secondary">Cancelado</span>
                    <% end %>
                  </td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm">
                      <%= link_to edit_training_course_path(course), class: 'btn btn-outline-primary', title: 'Editar' do %>
                        <i class="bi bi-pencil"></i>
                      <% end %>
                      <%= button_to training_course_path(course), method: :delete, class: 'btn btn-outline-danger',
                          title: 'Eliminar', data: { confirm: 'Tem certeza?' } do %>
                        <i class="bi bi-trash"></i>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
            <tfoot class="table-light">
              <tr>
                <th colspan="5" class="text-end">TOTAIS DO MÊS:</th>
                <th class="text-end">
                  <%= number_to_currency(@total_value, unit: 'AOA', separator: ',', delimiter: '.') %>
                </th>
                <th class="text-end text-success">
                  <%= number_to_currency(@total_paid, unit: 'AOA', separator: ',', delimiter: '.') %>
                </th>
                <th class="text-end text-warning">
                  <%= number_to_currency(@total_balance, unit: 'AOA', separator: ',', delimiter: '.') %>
                </th>
                <th colspan="3"></th>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-center mt-4">
          <%= paginate @training_courses %>
        </div>
      <% else %>
        <div class="text-center py-5 text-muted">
          <i class="bi bi-inbox fs-1"></i>
          <p class="mt-2">Sem cursos de formação registados para <%= nome_mes(@month) %> <%= @year %></p>
          <%= link_to 'Registar Novo Curso', new_training_course_path, class: 'btn btn-primary' %>
        </div>
      <% end %>
    </div>
  </div>
</div>
