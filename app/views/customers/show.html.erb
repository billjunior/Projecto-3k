<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1><i class="bi bi-person"></i> <%= @customer.name %></h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to 'Painel', root_path %></li>
          <li class="breadcrumb-item"><%= link_to 'Clientes', customers_path %></li>
          <li class="breadcrumb-item active"><%= @customer.name %></li>
        </ol>
      </nav>
    </div>
    <div class="col-auto">
      <%= link_to edit_customer_path(@customer), class: 'btn btn-warning' do %>
        <i class="bi bi-pencil"></i> Editar
      <% end %>
      <%= link_to @customer, data: { turbo_method: :delete, turbo_confirm: 'Tem a certeza?' }, class: 'btn btn-danger' do %>
        <i class="bi bi-trash"></i> Eliminar
      <% end %>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="card mb-3">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informação do Cliente</h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-4">Tipo:</dt>
            <dd class="col-sm-8">
              <span class="badge bg-<%= @customer.customer_type == 'empresa' ? 'info' : 'secondary' %>">
                <%= @customer.customer_type.capitalize %>
              </span>
            </dd>

            <% if @customer.tax_id.present? %>
              <dt class="col-sm-4">NIF:</dt>
              <dd class="col-sm-8"><%= @customer.tax_id %></dd>
            <% end %>

            <dt class="col-sm-4">Telefone:</dt>
            <dd class="col-sm-8">
              <%= phone_link(@customer.phone) %>
            </dd>

            <% if @customer.whatsapp.present? %>
              <dt class="col-sm-4">WhatsApp:</dt>
              <dd class="col-sm-8">
                <%= whatsapp_link(@customer.whatsapp) %>
              </dd>
            <% end %>

            <% if @customer.email.present? %>
              <dt class="col-sm-4">Email:</dt>
              <dd class="col-sm-8">
                <i class="bi bi-envelope"></i> <%= @customer.email %>
              </dd>
            <% end %>

            <% if @customer.address.present? %>
              <dt class="col-sm-4">Morada:</dt>
              <dd class="col-sm-8"><%= simple_format(@customer.address) %></dd>
            <% end %>

            <% if @customer.notes.present? %>
              <dt class="col-sm-12 mt-3"><strong>Notas:</strong></dt>
              <dd class="col-sm-12"><%= simple_format(@customer.notes) %></dd>
            <% end %>
          </dl>
        </div>
        <div class="card-footer text-muted">
          <small>Cliente desde <%= @customer.created_at.strftime('%d/%m/%Y') %></small>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <!-- Trabalhos -->
      <div class="card mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-printer"></i> Trabalhos Recentes</h5>
          <%= link_to new_job_path(customer_id: @customer.id), class: 'btn btn-sm btn-primary' do %>
            <i class="bi bi-plus"></i> Novo Trabalho
          <% end %>
        </div>
        <div class="card-body p-0">
          <% if @jobs.any? %>
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Data</th>
                    <th>Status</th>
                    <th>Total</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @jobs.each do |job| %>
                    <tr>
                      <td>#<%= job.id %></td>
                      <td><%= job.created_at.strftime('%d/%m/%Y') %></td>
                      <td>
                        <span class="badge bg-<%= job.status == 'completed' ? 'success' : 'warning' %>">
                          <%= job.status&.capitalize %>
                        </span>
                      </td>
                      <td><%= number_to_currency(job.total_amount, unit: "AOA") %></td>
                      <td class="text-end">
                        <%= link_to 'Ver', job, class: 'btn btn-sm btn-outline-primary' %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted p-3 mb-0">Nenhum trabalho registrado</p>
          <% end %>
        </div>
      </div>

      <!-- Sessões LAN -->
      <div class="card mb-3">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="bi bi-pc-display"></i> Sessões LAN Recentes</h5>
        </div>
        <div class="card-body p-0">
          <% if @lan_sessions.any? %>
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0">
                <thead>
                  <tr>
                    <th>Máquina</th>
                    <th>Início</th>
                    <th>Fim</th>
                    <th>Duração</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  <% @lan_sessions.each do |session| %>
                    <tr>
                      <td><%= session.lan_machine.name %></td>
                      <td><%= session.start_time.strftime('%d/%m/%Y %H:%M') %></td>
                      <td>
                        <%= session.end_time ? session.end_time.strftime('%H:%M') : '<span class="badge bg-success">Ativa</span>'.html_safe %>
                      </td>
                      <td><%= session.total_minutes ? "#{session.total_minutes} min" : '-' %></td>
                      <td><%= session.total_value ? number_to_currency(session.total_value, unit: "AOA") : '-' %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted p-3 mb-0">Nenhuma sessão registrada</p>
          <% end %>
        </div>
      </div>

      <!-- Faturas -->
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-receipt"></i> Faturas Recentes</h5>
          <%= link_to new_invoice_path(customer_id: @customer.id), class: 'btn btn-sm btn-warning' do %>
            <i class="bi bi-plus"></i> Nova Fatura
          <% end %>
        </div>
        <div class="card-body p-0">
          <% if @invoices.any? %>
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0">
                <thead>
                  <tr>
                    <th>Número</th>
                    <th>Data</th>
                    <th>Total</th>
                    <th>Pago</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <% @invoices.each do |invoice| %>
                    <tr>
                      <td>#<%= invoice.invoice_number %></td>
                      <td><%= invoice.invoice_date.strftime('%d/%m/%Y') %></td>
                      <td><%= number_to_currency(invoice.total_amount, unit: "AOA") %></td>
                      <td><%= number_to_currency(invoice.paid_amount, unit: "AOA") %></td>
                      <td>
                        <span class="badge bg-<%= invoice.status == 'paid' ? 'success' : invoice.status == 'pending' ? 'danger' : 'warning' %>">
                          <%= invoice.status&.capitalize %>
                        </span>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="text-muted p-3 mb-0">Nenhuma fatura registrada</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
