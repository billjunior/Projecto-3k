<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1><i class="bi bi-kanban"></i> Pipeline de Oportunidades</h1>
    </div>
    <div class="col-auto">
      <%= link_to opportunities_path, class: 'btn btn-secondary' do %>
        <i class="bi bi-list"></i> Vista de Lista
      <% end %>
      <%= link_to new_opportunity_path, class: 'btn btn-primary' do %>
        <i class="bi bi-plus-circle"></i> Nova Oportunidade
      <% end %>
    </div>
  </div>

  <!-- Stats Summary -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-pie-chart"></i> Total Oportunidades</h5>
          <h2><%= @stats[:total] %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-hourglass-split"></i> Abertas</h5>
          <h2><%= @stats[:open] %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-trophy"></i> Ganhas</h5>
          <h2><%= @stats[:won] %></h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-dark">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-cash-stack"></i> Valor Ponderado</h5>
          <h2><%= number_to_currency(@stats[:weighted_value], unit: 'AOA', separator: ',', delimiter: '.') %></h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Kanban Board -->
  <div class="kanban-board" data-controller="kanban">
    <div class="row">
      <!-- New Column -->
      <div class="col-md-2">
        <div class="kanban-column" data-stage="new_opportunity">
          <div class="kanban-column-header bg-secondary text-white">
            <h5><i class="bi bi-star"></i> Novo</h5>
            <small><%= @opportunities_by_stage[:new_opportunity].count %> oportunidades</small>
            <div><%= number_to_currency(@stage_values[:new_opportunity], unit: 'AOA', separator: ',', delimiter: '.') %></div>
          </div>
          <div class="kanban-column-body" data-kanban-target="column" data-stage="new_opportunity">
            <% @opportunities_by_stage[:new_opportunity].each do |opportunity| %>
              <%= render 'opportunity_card', opportunity: opportunity %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Qualified Column -->
      <div class="col-md-2">
        <div class="kanban-column" data-stage="qualified">
          <div class="kanban-column-header bg-info text-white">
            <h5><i class="bi bi-check-circle"></i> Qualificado</h5>
            <small><%= @opportunities_by_stage[:qualified].count %> oportunidades</small>
            <div><%= number_to_currency(@stage_values[:qualified], unit: 'AOA', separator: ',', delimiter: '.') %></div>
          </div>
          <div class="kanban-column-body" data-kanban-target="column" data-stage="qualified">
            <% @opportunities_by_stage[:qualified].each do |opportunity| %>
              <%= render 'opportunity_card', opportunity: opportunity %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Proposal Column -->
      <div class="col-md-2">
        <div class="kanban-column" data-stage="proposal">
          <div class="kanban-column-header bg-primary text-white">
            <h5><i class="bi bi-file-earmark-text"></i> Proposta</h5>
            <small><%= @opportunities_by_stage[:proposal].count %> oportunidades</small>
            <div><%= number_to_currency(@stage_values[:proposal], unit: 'AOA', separator: ',', delimiter: '.') %></div>
          </div>
          <div class="kanban-column-body" data-kanban-target="column" data-stage="proposal">
            <% @opportunities_by_stage[:proposal].each do |opportunity| %>
              <%= render 'opportunity_card', opportunity: opportunity %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Negotiation Column -->
      <div class="col-md-2">
        <div class="kanban-column" data-stage="negotiation">
          <div class="kanban-column-header bg-warning text-dark">
            <h5><i class="bi bi-chat-dots"></i> Negociação</h5>
            <small><%= @opportunities_by_stage[:negotiation].count %> oportunidades</small>
            <div><%= number_to_currency(@stage_values[:negotiation], unit: 'AOA', separator: ',', delimiter: '.') %></div>
          </div>
          <div class="kanban-column-body" data-kanban-target="column" data-stage="negotiation">
            <% @opportunities_by_stage[:negotiation].each do |opportunity| %>
              <%= render 'opportunity_card', opportunity: opportunity %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Won Column -->
      <div class="col-md-2">
        <div class="kanban-column" data-stage="won">
          <div class="kanban-column-header bg-success text-white">
            <h5><i class="bi bi-trophy"></i> Ganho</h5>
            <small><%= @opportunities_by_stage[:won].count %> oportunidades</small>
            <div><%= number_to_currency(@stage_values[:won], unit: 'AOA', separator: ',', delimiter: '.') %></div>
          </div>
          <div class="kanban-column-body" data-kanban-target="column" data-stage="won">
            <% @opportunities_by_stage[:won].each do |opportunity| %>
              <%= render 'opportunity_card', opportunity: opportunity %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Lost Column -->
      <div class="col-md-2">
        <div class="kanban-column" data-stage="lost">
          <div class="kanban-column-header bg-danger text-white">
            <h5><i class="bi bi-x-circle"></i> Perdido</h5>
            <small><%= @opportunities_by_stage[:lost].count %> oportunidades</small>
            <div><%= number_to_currency(@stage_values[:lost], unit: 'AOA', separator: ',', delimiter: '.') %></div>
          </div>
          <div class="kanban-column-body" data-kanban-target="column" data-stage="lost">
            <% @opportunities_by_stage[:lost].each do |opportunity| %>
              <%= render 'opportunity_card', opportunity: opportunity %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .kanban-board {
    overflow-x: auto;
  }

  .kanban-column {
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .kanban-column-header {
    padding: 15px;
    border-radius: 8px 8px 0 0;
    text-align: center;
  }

  .kanban-column-header h5 {
    margin: 0;
    font-size: 1rem;
  }

  .kanban-column-header small {
    display: block;
    margin-top: 5px;
    opacity: 0.9;
  }

  .kanban-column-body {
    padding: 10px;
    min-height: 500px;
  }

  .kanban-card {
    background: #fafbfc;
    border: 1px solid #e1e4e8;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: move;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }

  .kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    background: #f6f8fa;
  }

  .kanban-card .text-muted {
    color: #495057 !important;
  }

  .kanban-card small {
    color: #586069;
    font-weight: 500;
  }

  .kanban-card.dragging {
    opacity: 0.5;
  }

  .kanban-column-body.drag-over {
    background: #e9ecef;
    border: 2px dashed #6c757d;
  }
</style>
