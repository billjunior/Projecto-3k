<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-7">
      <div class="card mt-5">
        <div class="card-header bg-warning text-dark">
          <h4 class="mb-0"><i class="bi bi-shield-lock"></i> Troca de Senha Obrigatória</h4>
        </div>
        <div class="card-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Atenção!</strong> Você precisa alterar sua senha por motivo de: <strong><%= @reason %></strong>
          </div>

          <% if flash[:alert] %>
            <div class="alert alert-danger">
              <%= flash[:alert] %>
            </div>
          <% end %>

          <%= form_with url: change_password_path, method: :put, local: true do |f| %>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="text" class="form-control" value="<%= @user&.email %>" disabled>
            </div>

            <div class="mb-3">
              <%= f.label :password, 'Nova Senha', class: 'form-label' %>
              <%= password_field_tag 'user[password]', '',
                  class: 'form-control',
                  id: 'password-input',
                  placeholder: 'Digite sua nova senha',
                  required: true,
                  autocomplete: 'new-password' %>
            </div>

            <div class="mb-3">
              <%= f.label :password_confirmation, 'Confirmar Nova Senha', class: 'form-label' %>
              <%= password_field_tag 'user[password_confirmation]', '',
                  class: 'form-control',
                  id: 'password-confirmation',
                  placeholder: 'Digite a senha novamente',
                  required: true,
                  autocomplete: 'new-password' %>
              <div id="password-match-feedback" class="mt-1" style="display: none;"></div>
            </div>

            <!-- Password Requirements Checklist -->
            <div class="card bg-light mb-3">
              <div class="card-body">
                <h6 class="card-title mb-2"><i class="bi bi-check-circle"></i> Requisitos da Senha:</h6>
                <ul class="list-unstyled mb-0" id="password-requirements">
                  <li id="req-length" class="text-muted">
                    <i class="bi bi-circle"></i> Mínimo de 12 caracteres
                  </li>
                  <li id="req-uppercase" class="text-muted">
                    <i class="bi bi-circle"></i> Pelo menos uma letra maiúscula (A-Z)
                  </li>
                  <li id="req-lowercase" class="text-muted">
                    <i class="bi bi-circle"></i> Pelo menos uma letra minúscula (a-z)
                  </li>
                  <li id="req-number" class="text-muted">
                    <i class="bi bi-circle"></i> Pelo menos um número (0-9)
                  </li>
                  <li id="req-special" class="text-muted">
                    <i class="bi bi-circle"></i> Pelo menos um caractere especial (!@#$%^&*()_+-=[]{}|;:,.<>?)
                  </li>
                </ul>
              </div>
            </div>

            <div class="d-grid">
              <%= f.submit 'Alterar Senha', class: 'btn btn-warning btn-lg', id: 'submit-btn', disabled: true %>
            </div>
          <% end %>

          <div class="mt-3 text-center">
            <small class="text-muted">
              <i class="bi bi-info-circle"></i>
              Após alterar a senha, você será <%= @user&.privileged_user? ? 'redirecionado para fazer login' : 'automaticamente conectado' %>.
              <br>
              <strong>Lembre-se:</strong> Você deverá trocar sua senha a cada 90 dias.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const passwordInput = document.getElementById('password-input');
  const confirmInput = document.getElementById('password-confirmation');
  const submitBtn = document.getElementById('submit-btn');
  const matchFeedback = document.getElementById('password-match-feedback');

  const requirements = {
    length: { element: document.getElementById('req-length'), regex: /.{12,}/ },
    uppercase: { element: document.getElementById('req-uppercase'), regex: /[A-Z]/ },
    lowercase: { element: document.getElementById('req-lowercase'), regex: /[a-z]/ },
    number: { element: document.getElementById('req-number'), regex: /\d/ },
    special: { element: document.getElementById('req-special'), regex: /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/ }
  };

  function checkRequirements() {
    const password = passwordInput.value;
    let allMet = true;

    Object.keys(requirements).forEach(key => {
      const req = requirements[key];
      const met = req.regex.test(password);

      if (met) {
        req.element.className = 'text-success';
        req.element.querySelector('i').className = 'bi bi-check-circle-fill';
      } else {
        req.element.className = 'text-muted';
        req.element.querySelector('i').className = 'bi bi-circle';
        allMet = false;
      }
    });

    return allMet;
  }

  function checkPasswordMatch() {
    const password = passwordInput.value;
    const confirmation = confirmInput.value;

    if (confirmation.length === 0) {
      matchFeedback.style.display = 'none';
      return false;
    }

    matchFeedback.style.display = 'block';

    if (password === confirmation) {
      matchFeedback.className = 'text-success small';
      matchFeedback.innerHTML = '<i class="bi bi-check-circle-fill"></i> As senhas coincidem';
      return true;
    } else {
      matchFeedback.className = 'text-danger small';
      matchFeedback.innerHTML = '<i class="bi bi-x-circle-fill"></i> As senhas não coincidem';
      return false;
    }
  }

  function updateSubmitButton() {
    const requirementsMet = checkRequirements();
    const passwordsMatch = checkPasswordMatch();
    submitBtn.disabled = !(requirementsMet && passwordsMatch && passwordInput.value.length > 0);
  }

  passwordInput.addEventListener('input', updateSubmitButton);
  confirmInput.addEventListener('input', updateSubmitButton);
});
</script>
