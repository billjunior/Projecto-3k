<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1><i class="bi bi-box-seam"></i> Inventário</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to 'Cyber Café', lan_machines_path %></li>
          <li class="breadcrumb-item active" aria-current="page">Inventário</li>
        </ol>
      </nav>
    </div>
    <div class="col-auto">
      <button type="button" class="btn btn-warning me-2" id="batchExitBtn" style="display: none;" data-bs-toggle="modal" data-bs-target="#batchExitModal">
        <i class="bi bi-box-arrow-up"></i> Retirar Selecionados (<span id="selectedCount">0</span>)
      </button>
      <%= link_to inventory_items_path(format: :pdf), class: 'btn btn-danger me-2', target: '_blank' do %>
        <i class="bi bi-file-pdf"></i> Exportar PDF
      <% end %>
      <%= link_to reports_inventory_items_path, class: 'btn btn-info me-2' do %>
        <i class="bi bi-graph-up"></i> Relatórios
      <% end %>
      <%= link_to new_inventory_item_path, class: 'btn btn-primary' do %>
        <i class="bi bi-plus-circle"></i> Adicionar Produto
      <% end %>
    </div>
  </div>

  <!-- Filter Buttons -->
  <div class="row mb-3">
    <div class="col">
      <div class="btn-group" role="group">
        <%= link_to inventory_items_path, class: "btn btn-sm #{params[:filter].blank? ? 'btn-primary' : 'btn-outline-primary'}" do %>
          <i class="bi bi-list"></i> Todos
        <% end %>
        <%= link_to inventory_items_path(filter: 'low_stock'), class: "btn btn-sm #{params[:filter] == 'low_stock' ? 'btn-warning' : 'btn-outline-warning'}" do %>
          <i class="bi bi-exclamation-triangle"></i> Stock Baixo
        <% end %>
        <%= link_to inventory_items_path(filter: 'out_of_stock'), class: "btn btn-sm #{params[:filter] == 'out_of_stock' ? 'btn-danger' : 'btn-outline-danger'}" do %>
          <i class="bi bi-x-circle"></i> Sem Stock
        <% end %>
        <%= link_to inventory_items_path(filter: 'in_stock'), class: "btn btn-sm #{params[:filter] == 'in_stock' ? 'btn-success' : 'btn-outline-success'}" do %>
          <i class="bi bi-check-circle"></i> Com Stock
        <% end %>
      </div>
    </div>
  </div>

  <!-- Inventory Table -->
  <div class="card">
    <div class="card-body p-0">
      <% if @inventory_items.any? %>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th width="40">
                  <input type="checkbox" id="selectAll" class="form-check-input">
                </th>
                <th>Fornecedor</th>
                <th>Produto</th>
                <th class="text-end">Qtd. Bruta</th>
                <th class="text-end">Qtd. Líquida</th>
                <th class="text-end">Stock Mínimo</th>
                <th class="text-end">Preço Compra</th>
                <th class="text-center">Status</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody>
              <% @inventory_items.each do |item| %>
                <tr class="<%= 'table-danger' if item.stock_status == 'out_of_stock' %>
                           <%= 'table-warning' if item.stock_status == 'low_stock' %>">
                  <td>
                    <% if item.net_quantity > 0 %>
                      <input type="checkbox" class="form-check-input item-checkbox"
                             data-item-id="<%= item.id %>"
                             data-item-name="<%= item.product_name %>"
                             data-max-quantity="<%= item.net_quantity %>">
                    <% end %>
                  </td>
                  <td>
                    <i class="bi bi-phone"></i> <%= item.supplier_phone %>
                  </td>
                  <td>
                    <strong><%= item.product_name %></strong>
                  </td>
                  <td class="text-end">
                    <%= number_with_precision(item.gross_quantity, precision: 2, delimiter: ".", separator: ",") %>
                  </td>
                  <td class="text-end">
                    <strong><%= number_with_precision(item.net_quantity, precision: 2, delimiter: ".", separator: ",") %></strong>
                  </td>
                  <td class="text-end">
                    <%= item.minimum_stock %>
                  </td>
                  <td class="text-end">
                    <%= number_to_currency(item.purchase_price, unit: "AOA", separator: ",", delimiter: ".") %>
                  </td>
                  <td class="text-center">
                    <% case item.stock_status %>
                    <% when 'out_of_stock' %>
                      <span class="badge bg-danger">Sem Stock</span>
                    <% when 'low_stock' %>
                      <span class="badge bg-warning text-dark">Stock Baixo</span>
                    <% else %>
                      <span class="badge bg-success">Normal</span>
                    <% end %>
                  </td>
                  <td class="text-end">
                    <%= link_to inventory_item_path(item), class: 'btn btn-sm btn-outline-primary me-1' do %>
                      <i class="bi bi-eye"></i>
                    <% end %>
                    <%= link_to edit_inventory_item_path(item), class: 'btn btn-sm btn-outline-secondary me-1' do %>
                      <i class="bi bi-pencil"></i>
                    <% end %>
                    <%= link_to inventory_item_path(item),
                        data: { turbo_method: :delete, turbo_confirm: 'Tem certeza que deseja remover este produto?' },
                        class: 'btn btn-sm btn-outline-danger' do %>
                      <i class="bi bi-trash"></i>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-center mt-4 mb-3">
          <%= paginate @inventory_items %>
        </div>
      <% else %>
        <div class="text-center py-5 text-muted">
          <i class="bi bi-box-seam fs-1"></i>
          <p class="mt-2">Nenhum produto no inventário</p>
          <%= link_to new_inventory_item_path, class: 'btn btn-primary' do %>
            <i class="bi bi-plus-circle"></i> Adicionar Primeiro Produto
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Batch Exit Modal -->
<div class="modal fade" id="batchExitModal" tabindex="-1" aria-labelledby="batchExitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <%= form_with url: batch_exit_inventory_items_path, method: :post, local: true do |form| %>
        <div class="modal-header bg-warning">
          <h5 class="modal-title" id="batchExitModalLabel">
            <i class="bi bi-box-arrow-up"></i> Retirar Múltiplos Itens do Inventário
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Configure as quantidades a retirar para cada item selecionado.
            A data será registada automaticamente como hoje (<strong><%= Date.today.strftime('%d/%m/%Y') %></strong>).
          </div>

          <div id="selectedItemsList"></div>

          <div class="mb-3">
            <%= form.label :notes, 'Notas gerais (opcional)', class: 'form-label' %>
            <%= form.text_area :notes, class: 'form-control', rows: 2,
                placeholder: 'Ex: Saída para venda, consumo interno, etc.' %>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <%= form.submit 'Processar Saídas', class: 'btn btn-warning' %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('turbo:load', function() {
  const selectAllCheckbox = document.getElementById('selectAll');
  const itemCheckboxes = document.querySelectorAll('.item-checkbox');
  const batchExitBtn = document.getElementById('batchExitBtn');
  const selectedCount = document.getElementById('selectedCount');
  const selectedItemsList = document.getElementById('selectedItemsList');

  // Select All functionality
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      itemCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
      updateSelectedItems();
    });
  }

  // Individual checkbox change
  itemCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      updateSelectedItems();
    });
  });

  function updateSelectedItems() {
    const checked = document.querySelectorAll('.item-checkbox:checked');
    const count = checked.length;

    selectedCount.textContent = count;

    if (count > 0) {
      batchExitBtn.style.display = 'inline-block';
      buildSelectedItemsForm(checked);
    } else {
      batchExitBtn.style.display = 'none';
    }

    // Update select all checkbox state
    if (selectAllCheckbox) {
      selectAllCheckbox.checked = count === itemCheckboxes.length && count > 0;
    }
  }

  function buildSelectedItemsForm(checkedBoxes) {
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>Produto</th><th>Stock Disponível</th><th>Quantidade a Retirar</th></tr></thead>';
    html += '<tbody>';

    checkedBoxes.forEach((checkbox, index) => {
      const itemId = checkbox.dataset.itemId;
      const itemName = checkbox.dataset.itemName;
      const maxQuantity = parseFloat(checkbox.dataset.maxQuantity);

      html += `
        <tr>
          <td><strong>${itemName}</strong></td>
          <td class="text-end">${maxQuantity.toFixed(2)}</td>
          <td>
            <input type="hidden" name="items[${index}][id]" value="${itemId}">
            <input type="number"
                   name="items[${index}][quantity]"
                   class="form-control form-control-sm"
                   min="0.01"
                   max="${maxQuantity}"
                   step="0.01"
                   value="${maxQuantity}"
                   required>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table></div>';
    selectedItemsList.innerHTML = html;
  }

  // Initialize on page load
  updateSelectedItems();
});
</script>
