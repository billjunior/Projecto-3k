<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h1>
        <i class="bi bi-file-earmark-text"></i> <%= @estimate.estimate_number %>
        <span class="badge bg-<%= case @estimate.status
          when 'rascunho' then 'secondary'
          when 'pendente_aprovacao' then 'warning'
          when 'aprovado' then 'success'
          when 'recusado' then 'danger'
          else 'secondary'
        end %>">
          <%= @estimate.status.humanize %>
        </span>
      </h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to 'Painel', root_path %></li>
          <li class="breadcrumb-item"><%= link_to 'Orçamentos', estimates_path %></li>
          <li class="breadcrumb-item active"><%= @estimate.estimate_number %></li>
        </ol>
      </nav>
    </div>
    <div class="col-auto">
      <% if @estimate.status == 'rascunho' %>
        <%= link_to edit_estimate_path(@estimate), class: 'btn btn-warning' do %>
          <i class="bi bi-pencil"></i> Editar
        <% end %>
        <% if @estimate.can_submit_for_approval? %>
          <%= link_to submit_for_approval_estimate_path(@estimate), data: { turbo_method: :post, turbo_confirm: 'Enviar para aprovação?' }, class: 'btn btn-primary' do %>
            <i class="bi bi-send"></i> Enviar para Aprovação
          <% end %>
        <% end %>
      <% elsif @estimate.status == 'pendente_aprovacao' %>
        <% if current_user.role.in?(['admin', 'financeiro']) %>
          <%= link_to approve_estimate_path(@estimate), data: { turbo_method: :post, turbo_confirm: 'Aprovar orçamento?' }, class: 'btn btn-success' do %>
            <i class="bi bi-check-circle"></i> Aprovar
          <% end %>
          <%= link_to reject_estimate_path(@estimate), data: { turbo_method: :post, turbo_confirm: 'Recusar orçamento?' }, class: 'btn btn-danger' do %>
            <i class="bi bi-x-circle"></i> Recusar
          <% end %>
        <% end %>
      <% elsif @estimate.status == 'aprovado' %>
        <%= link_to convert_to_job_estimate_path(@estimate), data: { turbo_method: :post, turbo_confirm: 'Criar trabalho a partir deste orçamento?' }, class: 'btn btn-info' do %>
          <i class="bi bi-arrow-right-circle"></i> Criar Trabalho
        <% end %>
      <% end %>

      <!-- Botões de Comunicação -->
      <div class="mt-3 d-flex gap-2">
        <!-- PDF Download -->
        <%= link_to pdf_estimate_path(@estimate), target: '_blank', class: 'btn btn-outline-secondary' do %>
          <i class="bi bi-file-pdf"></i> Baixar PDF
        <% end %>

        <!-- WhatsApp (apenas se cliente tiver telefone e orçamento aprovado) -->
        <% if @estimate.customer.phone.present? && @estimate.status == 'aprovado' %>
          <%
            whatsapp_message = "Olá #{@estimate.customer.name}! Seu orçamento #{@estimate.estimate_number} foi aprovado. Valor: #{number_to_currency(@estimate.total_value, unit: 'AOA')}. Entre em contato para mais detalhes."
            phone_clean = @estimate.customer.phone.gsub(/\D/, '')  # Remove caracteres não numéricos
            whatsapp_url = "https://wa.me/#{phone_clean}?text=#{CGI.escape(whatsapp_message)}"
          %>
          <%= link_to whatsapp_url, target: '_blank', class: 'btn btn-success' do %>
            <i class="bi bi-whatsapp"></i> WhatsApp
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="card mb-3">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informações</h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-5">Cliente:</dt>
            <dd class="col-sm-7"><%= link_to @estimate.customer.name, @estimate.customer %></dd>

            <dt class="col-sm-5">Status:</dt>
            <dd class="col-sm-7">
              <span class="badge bg-<%= case @estimate.status
                when 'rascunho' then 'secondary'
                when 'pendente_aprovacao' then 'warning'
                when 'aprovado' then 'success'
                when 'recusado' then 'danger'
                else 'secondary'
              end %>">
                <%= @estimate.status.humanize %>
              </span>
            </dd>

            <dt class="col-sm-5">Data Criação:</dt>
            <dd class="col-sm-7"><%= @estimate.created_at.strftime('%d/%m/%Y %H:%M') %></dd>

            <% if @estimate.valid_until %>
              <dt class="col-sm-5">Válido até:</dt>
              <dd class="col-sm-7">
                <span class="badge bg-<%= @estimate.valid_until < Date.today ? 'danger' : 'info' %>">
                  <%= @estimate.valid_until.strftime('%d/%m/%Y') %>
                </span>
              </dd>
            <% end %>

            <dt class="col-sm-5">Criado por:</dt>
            <dd class="col-sm-7"><small class="text-muted"><%= @estimate.created_by_user&.email || 'N/A' %></small></dd>

            <% if @estimate.approved_by.present? %>
              <dt class="col-sm-5"><%= @estimate.status == 'aprovado' ? 'Aprovado por:' : 'Recusado por:' %></dt>
              <dd class="col-sm-7"><small class="text-muted"><%= @estimate.approved_by %></small></dd>

              <% if @estimate.approved_at %>
                <dt class="col-sm-5">Data:</dt>
                <dd class="col-sm-7"><%= @estimate.approved_at.strftime('%d/%m/%Y %H:%M') %></dd>
              <% end %>
            <% end %>

            <dt class="col-sm-5">Valor Total:</dt>
            <dd class="col-sm-7"><strong class="text-primary"><%= number_to_currency(@estimate.total_value, unit: "AOA") %></strong></dd>
          </dl>

          <% if @estimate.notes.present? %>
            <hr>
            <strong>Notas:</strong>
            <p class="mb-0"><%= simple_format(@estimate.notes) %></p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="bi bi-list"></i> Items do Orçamento</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>Produto</th>
                  <th class="text-center">Quantidade</th>
                  <th class="text-end">Preço Unitário</th>
                  <th class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                <% @estimate_items.each do |item| %>
                  <tr>
                    <td><%= item.product.name %></td>
                    <td class="text-center"><%= item.quantity %></td>
                    <td class="text-end"><%= number_to_currency(item.unit_price, unit: "AOA") %></td>
                    <td class="text-end"><strong><%= number_to_currency(item.subtotal, unit: "AOA") %></strong></td>
                  </tr>
                <% end %>
              </tbody>
              <tfoot>
                <tr class="table-light">
                  <th colspan="3" class="text-end">Total:</th>
                  <th class="text-end">
                    <h4 class="text-primary mb-0"><%= number_to_currency(@estimate.total_value, unit: "AOA") %></h4>
                  </th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- Pricing Analysis Section (Directors Only) -->
      <% if current_user.role.in?(['super_admin', 'admin', 'financeiro']) %>
        <% analysis = @estimate.pricing_analysis %>
        <div class="card mt-3">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up"></i> Análise de Preços (Diretores)</h5>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-3">
                <div class="text-muted mb-1">Margem Esperada</div>
                <div class="fs-4 text-success">
                  <%= number_to_percentage(analysis[:expected_margin], precision: 0) %>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-muted mb-1">Margem Real</div>
                <div class="fs-4 <%= analysis[:actual_margin_percentage] < analysis[:expected_margin] ? 'text-danger' : 'text-success' %>">
                  <%= number_to_percentage(analysis[:actual_margin_percentage], precision: 2) %>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-muted mb-1">Custo Total</div>
                <div class="fs-5">
                  <%= number_to_currency(analysis[:total_cost], unit: 'AOA ') %>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-muted mb-1">Lucro Real</div>
                <div class="fs-5 <%= analysis[:total_profit] > 0 ? 'text-success' : 'text-danger' %>">
                  <%= number_to_currency(analysis[:total_profit], unit: 'AOA ') %>
                </div>
              </div>
            </div>

            <% if @estimate.discount_percentage.present? && @estimate.discount_percentage > 0 %>
              <div class="alert alert-warning">
                <strong><i class="bi bi-percent"></i> Desconto Aplicado:</strong>
                <%= number_to_percentage(@estimate.discount_percentage, precision: 2) %>
                <% if @estimate.discount_amount.present? && @estimate.discount_amount > 0 %>
                  (<%= number_to_currency(@estimate.discount_amount, unit: 'AOA ') %>)
                <% end %>
              </div>

              <% if @estimate.discount_justification.present? %>
                <div class="card bg-light mb-3">
                  <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-chat-text"></i> Justificação do Desconto</h6>
                    <p class="card-text mb-0"><%= simple_format(@estimate.discount_justification) %></p>
                  </div>
                </div>
              <% end %>
            <% end %>

            <% if analysis[:has_warnings] %>
              <div class="alert alert-<%= case analysis[:severity]
                when 'low' then 'info'
                when 'medium' then 'warning'
                else 'danger'
              end %> mb-3">
                <strong><i class="bi bi-exclamation-triangle"></i> Aviso de Margem:</strong>
                A margem de lucro está <%= number_to_percentage(analysis[:margin_deficit], precision: 2) %>
                abaixo do esperado, resultando numa perda estimada de lucro de
                <%= number_to_currency(analysis[:profit_loss], unit: 'AOA ') %>.
              </div>

              <% if analysis[:below_margin_items].any? %>
                <h6><i class="bi bi-list-check"></i> Itens Abaixo da Margem Esperada:</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th>Produto</th>
                        <th class="text-center">Margem Real</th>
                        <th class="text-center">Défice</th>
                        <th class="text-end">Perda de Lucro</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% analysis[:below_margin_items].each do |item| %>
                        <tr>
                          <td><%= item[:product_name] %></td>
                          <td class="text-center text-danger">
                            <%= number_to_percentage(item[:margin_percentage], precision: 2) %>
                          </td>
                          <td class="text-center text-warning">
                            <%= number_to_percentage(item[:margin_gap], precision: 2) %>
                          </td>
                          <td class="text-end text-danger">
                            <%= number_to_currency(item[:profit_loss], unit: 'AOA ') %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              <% end %>
            <% else %>
              <div class="alert alert-success mb-0">
                <i class="bi bi-check-circle"></i>
                <strong>Margem de lucro adequada.</strong>
                Todos os itens estão dentro ou acima da margem esperada de
                <%= number_to_percentage(analysis[:expected_margin], precision: 0) %>.
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
