<%= form_with(model: estimate, local: true) do |form| %>
  <% if estimate.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(estimate.errors.count, "erro") %>:</h5>
      <ul class="mb-0">
        <% estimate.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-8">
      <div class="mb-3">
        <%= form.label :customer_id, 'Cliente', class: 'form-label' %>
        <%= form.select :customer_id,
            options_from_collection_for_select(@customers, :id, :name, estimate.customer_id),
            { prompt: 'Selecione um cliente' },
            class: 'form-select',
            required: true %>
      </div>
    </div>

    <div class="col-md-4">
      <div class="mb-3">
        <%= form.label :valid_until, 'Válido até', class: 'form-label' %>
        <%= form.date_field :valid_until, class: 'form-control' %>
      </div>
    </div>
  </div>

  <div class="mb-3">
    <%= form.label :notes, 'Notas', class: 'form-label' %>
    <%= form.text_area :notes, rows: 3, class: 'form-control' %>
  </div>

  <!-- Items -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="bi bi-list"></i> Items do Orçamento</h5>
    </div>
    <div class="card-body">
      <div id="estimate-items">
        <%= form.fields_for :estimate_items do |item_form| %>
          <div class="estimate-item border rounded p-3 mb-3">
            <%= item_form.hidden_field :_destroy, class: 'item-destroy' %>

            <div class="row">
              <div class="col-md-5">
                <div class="mb-2">
                  <%= item_form.label :product_id, 'Produto', class: 'form-label' %>
                  <%= item_form.select :product_id,
                      options_from_collection_for_select(@products, :id, :name, item_form.object.product_id),
                      { prompt: 'Selecione um produto' },
                      class: 'form-select product-select',
                      required: true %>
                </div>
              </div>

              <div class="col-md-2">
                <div class="mb-2">
                  <%= item_form.label :quantity, 'Quantidade', class: 'form-label' %>
                  <%= item_form.number_field :quantity, class: 'form-control quantity-input', min: 1, step: 1, required: true %>
                </div>
              </div>

              <div class="col-md-2">
                <div class="mb-2">
                  <%= item_form.label :unit_price, 'Preço Unit.', class: 'form-label' %>
                  <%= item_form.number_field :unit_price, class: 'form-control price-input', step: '0.01', min: '0', required: true %>
                </div>
              </div>

              <div class="col-md-2">
                <div class="mb-2">
                  <%= item_form.label :subtotal, 'Subtotal', class: 'form-label' %>
                  <%= item_form.number_field :subtotal, class: 'form-control subtotal-input', step: '0.01', readonly: true %>
                </div>
              </div>

              <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-danger mb-2 remove-item">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <button type="button" class="btn btn-outline-primary" id="add-item">
        <i class="bi bi-plus-circle"></i> Adicionar Item
      </button>
    </div>

    <div class="card-footer bg-light">
      <div class="row">
        <div class="col-md-8 text-end">
          <h5>Total:</h5>
        </div>
        <div class="col-md-4 text-end">
          <h4 class="text-primary" id="grand-total">AOA 0.00</h4>
        </div>
      </div>
    </div>
  </div>

  <%= form.hidden_field :total_value, id: 'total_value_field' %>

  <!-- Discount Section -->
  <div class="card mb-3" data-controller="pricing-validator">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="bi bi-percent"></i> Desconto</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <%= form.label :discount_percentage, 'Desconto (%)', class: 'form-label' %>
          <%= form.number_field :discount_percentage,
              class: 'form-control',
              step: '0.01',
              min: '0',
              max: '100',
              id: 'discount_percentage_field',
              data: {
                pricing_validator_target: 'discountInput',
                action: 'input->pricing-validator#validateDiscount'
              } %>
        </div>

        <div class="col-md-9">
          <%= form.label :discount_justification, 'Justificação (obrigatório se desconto > 0)', class: 'form-label' %>
          <%= form.text_area :discount_justification,
              rows: 2,
              class: 'form-control',
              placeholder: 'Mínimo 10 caracteres...',
              data: {
                pricing_validator_target: 'justification',
                action: 'input->pricing-validator#validateJustification'
              } %>
          <small class="text-muted">Se aplicar desconto, deve justificar com pelo menos 10 caracteres.</small>
        </div>
      </div>

      <!-- Real-time warnings -->
      <div class="mt-3" data-pricing-validator-target="warningContainer" style="display: none;">
        <div class="alert alert-warning mb-0">
          <strong><i class="bi bi-exclamation-triangle"></i> Avisos de Preço:</strong>
          <div data-pricing-validator-target="warningContent"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex gap-2">
    <%= form.submit 'Guardar Orçamento', class: 'btn btn-primary' %>
    <%= link_to 'Cancelar', estimates_path, class: 'btn btn-secondary' %>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let itemIndex = document.querySelectorAll('.estimate-item').length;

  // Calculate subtotals and total
  function calculateTotals() {
    let subtotal = 0;

    document.querySelectorAll('.estimate-item').forEach(item => {
      const destroyField = item.querySelector('.item-destroy');
      if (!destroyField || destroyField.value === 'true') return;

      const quantityInput = item.querySelector('.quantity-input');
      const priceInput = item.querySelector('.price-input');
      const subtotalInput = item.querySelector('.subtotal-input');

      const quantity = parseFloat(quantityInput?.value) || 0;
      const price = parseFloat(priceInput?.value) || 0;
      const itemSubtotal = quantity * price;

      if (subtotalInput) {
        subtotalInput.value = itemSubtotal.toFixed(2);
      }
      subtotal += itemSubtotal;
    });

    // Apply discount
    const discountPercentageField = document.getElementById('discount_percentage_field');
    const discountPercentage = parseFloat(discountPercentageField?.value) || 0;
    const discountAmount = (subtotal * discountPercentage / 100);
    const grandTotal = subtotal - discountAmount;

    console.log('Subtotal:', subtotal, 'Discount:', discountAmount, 'Grand Total:', grandTotal);

    const grandTotalElement = document.getElementById('grand-total');
    const totalValueField = document.getElementById('total_value_field');

    if (grandTotalElement) {
      grandTotalElement.textContent = 'AOA ' + grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    } else {
      console.error('Element grand-total not found');
    }

    if (totalValueField) {
      totalValueField.value = grandTotal.toFixed(2);
      console.log('Total value field updated:', totalValueField.value);
    } else {
      console.error('Element total_value_field not found');
    }
  }

  // Add event listeners to quantity, price, and discount inputs
  // Use event delegation for dynamic items
  document.body.addEventListener('input', function(e) {
    if (e.target.matches('.quantity-input') ||
        e.target.matches('.price-input') ||
        e.target.id === 'discount_percentage_field') {
      calculateTotals();
    }
  });

  // Also add change event for better compatibility
  document.body.addEventListener('change', function(e) {
    if (e.target.matches('.quantity-input') ||
        e.target.matches('.price-input') ||
        e.target.matches('.product-select') ||
        e.target.id === 'discount_percentage_field') {
      calculateTotals();
    }
  });

  // Remove item
  document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-item')) {
      const item = e.target.closest('.estimate-item');
      item.querySelector('.item-destroy').value = 'true';
      item.style.display = 'none';
      calculateTotals();
    }
  });

  // Get product options for new items
  function getProductOptions() {
    const firstSelect = document.querySelector('.product-select');
    if (!firstSelect) {
      // If no existing select, get products from data attribute or create empty
      return '<option value="">Selecione um produto</option>';
    }
    return Array.from(firstSelect.options).map(opt =>
      `<option value="${opt.value}">${opt.text}</option>`
    ).join('');
  }

  // Add new item
  document.getElementById('add-item').addEventListener('click', function() {
    const container = document.getElementById('estimate-items');
    const newItem = document.createElement('div');
    newItem.className = 'estimate-item border rounded p-3 mb-3';
    newItem.innerHTML = `
      <input type="hidden" name="estimate[estimate_items_attributes][${itemIndex}][_destroy]" value="false" class="item-destroy">

      <div class="row">
        <div class="col-md-5">
          <div class="mb-2">
            <label class="form-label">Produto</label>
            <select name="estimate[estimate_items_attributes][${itemIndex}][product_id]" class="form-select product-select" required>
              ${getProductOptions()}
            </select>
          </div>
        </div>

        <div class="col-md-2">
          <div class="mb-2">
            <label class="form-label">Quantidade</label>
            <input type="number" name="estimate[estimate_items_attributes][${itemIndex}][quantity]" class="form-control quantity-input" min="1" step="1" value="1" required>
          </div>
        </div>

        <div class="col-md-2">
          <div class="mb-2">
            <label class="form-label">Preço Unit.</label>
            <input type="number" name="estimate[estimate_items_attributes][${itemIndex}][unit_price]" class="form-control price-input" step="0.01" min="0" value="0" required>
          </div>
        </div>

        <div class="col-md-2">
          <div class="mb-2">
            <label class="form-label">Subtotal</label>
            <input type="number" name="estimate[estimate_items_attributes][${itemIndex}][subtotal]" class="form-control subtotal-input" step="0.01" value="0" readonly>
          </div>
        </div>

        <div class="col-md-1 d-flex align-items-end">
          <button type="button" class="btn btn-danger mb-2 remove-item">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    `;

    container.appendChild(newItem);
    itemIndex++;
    calculateTotals();
  });

  // Initial calculation
  calculateTotals();
});
</script>
